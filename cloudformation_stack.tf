resource "aws_cloudformation_stack" "tfer--VeeamBackupForAWS" {
  capabilities     = ["CAPABILITY_IAM"]
  disable_rollback = "false"
  name             = "VeeamBackupForAWS"

  outputs = {
    InstanceId = "i-0efae83c49ddad297"
  }

  template_body = "{\"AWSTemplateFormatVersion\":\"2010-09-09\",\"Conditions\":{\"CreateEIPCond\":{\"Fn::Equals\":[{\"Ref\":\"CreateEIP\"},\"true\"]},\"CreateLifecyclePolicyCond\":{\"Fn::Equals\":[{\"Ref\":\"CreateLifecyclePolicy\"},\"true\"]},\"CreateRebootAlarmCond\":{\"Fn::Equals\":[{\"Ref\":\"CreateRebootAlarm\"},\"true\"]},\"CreateRecoveryAlarmCond\":{\"Fn::Equals\":[{\"Ref\":\"CreateRecoveryAlarm\"},\"true\"]}},\"Description\":\"Veeam Cloud Backup for AWS CloudFormation template: Configure VCB instance. **WARNING** This template creates an Amazon Ec2 Instance with an IAM Role. You will be billed for the AWS resources used if you create a stack from this template.\",\"Mappings\":{\"RegionMap\":{\"ap-northeast-1\":{\"HVM64\":\"ami-073fce3e8ba01fd05\"},\"ap-northeast-2\":{\"HVM64\":\"ami-03ae7464b75e6107d\"},\"ap-south-1\":{\"HVM64\":\"ami-0fc0f1b1b2e95fe5a\"},\"ap-southeast-1\":{\"HVM64\":\"ami-097eb87f2de129b74\"},\"ap-southeast-2\":{\"HVM64\":\"ami-077bc03aca66827b3\"},\"ca-central-1\":{\"HVM64\":\"ami-0c3e996ca32c6083c\"},\"eu-central-1\":{\"HVM64\":\"ami-00b72b7a4cecdfcb1\"},\"eu-north-1\":{\"HVM64\":\"ami-0d527484565de7ea3\"},\"eu-west-1\":{\"HVM64\":\"ami-0fda84bf3bff6fc5d\"},\"eu-west-2\":{\"HVM64\":\"ami-0cf50f4d410e02481\"},\"eu-west-3\":{\"HVM64\":\"ami-0139dafcb2e75f7b0\"},\"me-south-1\":{\"HVM64\":\"ami-0847d9e777c7b9922\"},\"sa-east-1\":{\"HVM64\":\"ami-0f6c6821945e7f1cb\"},\"us-east-1\":{\"HVM64\":\"ami-0d76f8d5a5ca22258\"},\"us-east-2\":{\"HVM64\":\"ami-0bdbd05be2dcfebcb\"},\"us-west-1\":{\"HVM64\":\"ami-010d3004c098bc4eb\"},\"us-west-2\":{\"HVM64\":\"ami-00b7a521176975733\"}}},\"Metadata\":{\"AWS::CloudFormation::Interface\":{\"ParameterGroups\":[{\"Label\":{\"default\":\"Instance Configuration\"},\"Parameters\":[\"InstanceType\",\"KeyName\",\"CreateLifecyclePolicy\",\"CreateRebootAlarm\",\"CreateRecoveryAlarm\"]},{\"Label\":{\"default\":\"Network Configuration\"},\"Parameters\":[\"CreateEIP\",\"SSHLocation\",\"HTTPLocation\"]},{\"Label\":{\"default\":\"VPC and Subnet\"},\"Parameters\":[\"VcbVpcId\",\"VcbSubnetId\"]}],\"ParameterLabels\":{\"CreateEIP\":{\"default\":\"Create elasticIP for Veeam Backup for AWS Server?\"},\"CreateLifecyclePolicy\":{\"default\":\"Automatically backup Veeam Backup for AWS Server instance?\"},\"CreateRebootAlarm\":{\"default\":\"Automatically restart Veeam Backup for AWS Server instance on software failures?\"},\"CreateRecoveryAlarm\":{\"default\":\"Automatically restart Veeam Backup for AWS Server instance on infrastructure failures?\"},\"HTTPLocation\":{\"default\":\"Allowed Source IP Addresses for connection to HTTPS\"},\"InstanceType\":{\"default\":\"Instance type for Veeam Backup for AWS server\"},\"KeyName\":{\"default\":\"Key Pair for Veeam Backup for AWS Server\"},\"SSHLocation\":{\"default\":\"Allowed Source IP Addresses for connection to SSH\"},\"VcbSubnetId\":{\"default\":\"Subnet\"},\"VcbVpcId\":{\"default\":\"VPC\"}}}},\"Outputs\":{\"InstanceId\":{\"Description\":\"InstanceId of the newly created Vcb EC2 instance\",\"Value\":{\"Ref\":\"VcbEc2Instance\"}}},\"Parameters\":{\"CreateEIP\":{\"AllowedValues\":[true,false],\"Default\":\"false\",\"Description\":\"By default a dynamic IP will be created (and it could change during reboots of this instance)\",\"Type\":\"String\"},\"CreateLifecyclePolicy\":{\"AllowedValues\":[true,false],\"Default\":\"true\",\"Description\":\"The Lifecycle policy automaticaly protects Veeam Backup for AWS Server by taking volume snapshot every 12 hours\",\"Type\":\"String\"},\"CreateRebootAlarm\":{\"AllowedValues\":[true,false],\"Default\":\"true\",\"Description\":\"\",\"Type\":\"String\"},\"CreateRecoveryAlarm\":{\"AllowedValues\":[true,false],\"Default\":\"true\",\"Description\":\"\",\"Type\":\"String\"},\"HTTPLocation\":{\"AllowedPattern\":\"(\\\\d{1,3})\\\\.(\\\\d{1,3})\\\\.(\\\\d{1,3})\\\\.(\\\\d{1,3})/(\\\\d{1,2})\",\"ConstraintDescription\":\"must be a valid IP CIDR range of the form x.x.x.x/x\",\"Description\":\"The IP address range in CIDR format (e.g. 12.23.34.0/24) from which Veeam Backup for AWS Management portal will be accesible\",\"MaxLength\":\"18\",\"MinLength\":\"9\",\"Type\":\"String\"},\"InstanceType\":{\"AllowedValues\":[\"t2.medium\",\"t2.large\",\"t2.xlarge\",\"t2.2xlarge\",\"t3.medium\",\"t3.large\",\"t3.xlarge\",\"t3.2xlarge\"],\"ConstraintDescription\":\"must be a valid EC2 instance type.\",\"Default\":\"t2.medium\",\"Description\":\"\",\"Type\":\"String\"},\"KeyName\":{\"ConstraintDescription\":\"must be the name of an existing EC2 KeyPair.\",\"Description\":\"Select one, or create a new one at AWS console\",\"Type\":\"AWS::EC2::KeyPair::KeyName\"},\"SSHLocation\":{\"AllowedPattern\":\"(\\\\d{1,3})\\\\.(\\\\d{1,3})\\\\.(\\\\d{1,3})\\\\.(\\\\d{1,3})/(\\\\d{1,2})\",\"ConstraintDescription\":\"must be a valid IP CIDR range of the form x.x.x.x/x\",\"Description\":\"The IP address range in CIDR format (e.g. 12.23.34.0/24) from which Veeam Backup for AWS SSH service will be accesible\",\"MaxLength\":\"18\",\"MinLength\":\"9\",\"Type\":\"String\"},\"VcbSubnetId\":{\"Description\":\"Id of your existing Subnet\",\"Type\":\"AWS::EC2::Subnet::Id\"},\"VcbVpcId\":{\"Description\":\"Id of your existing VPC\",\"Type\":\"AWS::EC2::VPC::Id\"}},\"Resources\":{\"VcbEIP\":{\"Condition\":\"CreateEIPCond\",\"Properties\":{\"Domain\":\"vpc\"},\"Type\":\"AWS::EC2::EIP\"},\"VcbEIPAssociation\":{\"Condition\":\"CreateEIPCond\",\"Properties\":{\"AllocationId\":{\"Fn::GetAtt\":[\"VcbEIP\",\"AllocationId\"]},\"InstanceId\":{\"Ref\":\"VcbEc2Instance\"}},\"Type\":\"AWS::EC2::EIPAssociation\"},\"VcbEc2Instance\":{\"Properties\":{\"IamInstanceProfile\":{\"Ref\":\"VcbInstanceProfile\"},\"ImageId\":{\"Fn::FindInMap\":[\"RegionMap\",{\"Ref\":\"AWS::Region\"},\"HVM64\"]},\"InstanceType\":{\"Ref\":\"InstanceType\"},\"KeyName\":{\"Ref\":\"KeyName\"},\"SecurityGroupIds\":[{\"Ref\":\"VcbSecurityGroup\"}],\"SubnetId\":{\"Ref\":\"VcbSubnetId\"},\"Tags\":[{\"Key\":\"Name\",\"Value\":{\"Ref\":\"AWS::StackName\"}}],\"UserData\":{\"Fn::Base64\":{\"Fn::Join\":[\"\\n\",[{\"Fn::GetAtt\":[\"VeeamImpersonationRoleV1\",\"Arn\"]},{\"Fn::GetAtt\":[\"VeeamInstanceBackupRestoreAccessRoleV1\",\"Arn\"]}]]}}},\"Type\":\"AWS::EC2::Instance\"},\"VcbInstanceProfile\":{\"Properties\":{\"Path\":\"/\",\"Roles\":[{\"Ref\":\"VeeamImpersonationRoleV1\"}]},\"Type\":\"AWS::IAM::InstanceProfile\"},\"VcbLifecyclePolicy\":{\"Condition\":\"CreateLifecyclePolicyCond\",\"Properties\":{\"Description\":\"Lifecycle Policy for a Veeam Cloud Backup instance\",\"ExecutionRoleArn\":{\"Fn::GetAtt\":[\"VcbSnapshotsRole\",\"Arn\"]},\"PolicyDetails\":{\"ResourceTypes\":[\"INSTANCE\"],\"Schedules\":[{\"CopyTags\":true,\"CreateRule\":{\"Interval\":12,\"IntervalUnit\":\"HOURS\",\"Times\":[\"03:00\"]},\"Name\":\"Vcb instance daily snapshots\",\"RetainRule\":{\"Count\":1},\"TagsToAdd\":[{\"Key\":\"type\",\"Value\":\"VcbDailySnapshot\"}]}],\"TargetTags\":[{\"Key\":\"aws:cloudformation:stack-name\",\"Value\":{\"Ref\":\"AWS::StackName\"}}]},\"State\":\"ENABLED\"},\"Type\":\"AWS::DLM::LifecyclePolicy\"},\"VcbRebootAlarm\":{\"Condition\":\"CreateRebootAlarmCond\",\"Properties\":{\"AlarmActions\":[{\"Fn::Join\":[\"\",[\"arn:aws:automate:\",{\"Ref\":\"AWS::Region\"},\":ec2:reboot\"]]}],\"AlarmDescription\":\"Trigger a reboot when instance status check fails for 3 consecutive minutes.\",\"ComparisonOperator\":\"GreaterThanThreshold\",\"Dimensions\":[{\"Name\":\"InstanceId\",\"Value\":{\"Ref\":\"VcbEc2Instance\"}}],\"EvaluationPeriods\":\"3\",\"MetricName\":\"StatusCheckFailed_Instance\",\"Namespace\":\"AWS/EC2\",\"Period\":\"60\",\"Statistic\":\"Minimum\",\"Threshold\":\"0\"},\"Type\":\"AWS::CloudWatch::Alarm\"},\"VcbRecoveryAlarm\":{\"Condition\":\"CreateRecoveryAlarmCond\",\"Properties\":{\"AlarmActions\":[{\"Fn::Join\":[\"\",[\"arn:aws:automate:\",{\"Ref\":\"AWS::Region\"},\":ec2:recover\"]]}],\"AlarmDescription\":\"Trigger a recovery when system status check fails for 15 consecutive minutes.\",\"ComparisonOperator\":\"GreaterThanThreshold\",\"Dimensions\":[{\"Name\":\"InstanceId\",\"Value\":{\"Ref\":\"VcbEc2Instance\"}}],\"EvaluationPeriods\":\"2\",\"MetricName\":\"StatusCheckFailed_System\",\"Namespace\":\"AWS/EC2\",\"Period\":\"60\",\"Statistic\":\"Minimum\",\"Threshold\":\"0\"},\"Type\":\"AWS::CloudWatch::Alarm\"},\"VcbSecurityGroup\":{\"Properties\":{\"GroupDescription\":\"Enable SSH \\u0026 HTTPS access via ports 22 \\u0026 443\",\"SecurityGroupIngress\":[{\"CidrIp\":{\"Ref\":\"SSHLocation\"},\"FromPort\":\"22\",\"IpProtocol\":\"tcp\",\"ToPort\":\"22\"},{\"CidrIp\":{\"Ref\":\"HTTPLocation\"},\"FromPort\":\"443\",\"IpProtocol\":\"tcp\",\"ToPort\":\"443\"}],\"VpcId\":{\"Ref\":\"VcbVpcId\"}},\"Type\":\"AWS::EC2::SecurityGroup\"},\"VcbSnapshotsRole\":{\"Condition\":\"CreateLifecyclePolicyCond\",\"Properties\":{\"AssumeRolePolicyDocument\":{\"Statement\":[{\"Action\":[\"sts:AssumeRole\"],\"Effect\":\"Allow\",\"Principal\":{\"Service\":[\"dlm.amazonaws.com\"]}}],\"Version\":\"2012-10-17\"},\"Path\":\"/\",\"Policies\":[{\"PolicyDocument\":{\"Statement\":[{\"Action\":[\"ec2:DescribeVolumes\",\"ec2:DescribeInstances\",\"ec2:DescribeSnapshots\"],\"Effect\":\"Allow\",\"Resource\":\"*\"}],\"Version\":\"2012-10-17\"},\"PolicyName\":\"vcb-describe-snap\"},{\"PolicyDocument\":{\"Statement\":[{\"Action\":[\"ec2:DeleteSnapshot\",\"ec2:CreateTags\"],\"Effect\":\"Allow\",\"Resource\":{\"Fn::Join\":[\"\",[\"arn:aws:ec2:\",{\"Ref\":\"AWS::Region\"},\"::snapshot/*\"]]}},{\"Action\":[\"ec2:CreateSnapshot\",\"ec2:CreateSnapshots\"],\"Effect\":\"Allow\",\"Resource\":\"*\"}],\"Version\":\"2012-10-17\"},\"PolicyName\":\"vcb-modify-snap\"}]},\"Type\":\"AWS::IAM::Role\"},\"VeeamImpersonationRoleV1\":{\"Properties\":{\"AssumeRolePolicyDocument\":{\"Statement\":[{\"Action\":[\"sts:AssumeRole\"],\"Effect\":\"Allow\",\"Principal\":{\"Service\":[\"ec2.amazonaws.com\"]}}],\"Version\":\"2012-10-17\"},\"Path\":\"/\",\"Policies\":[{\"PolicyDocument\":{\"Statement\":[{\"Action\":[\"sts:AssumeRole\"],\"Effect\":\"Allow\",\"Resource\":\"*\"}],\"Version\":\"2012-10-17\"},\"PolicyName\":\"vcb-assume\"}]},\"Type\":\"AWS::IAM::Role\"},\"VeeamInstanceBackupRestoreAccessRoleV1\":{\"Properties\":{\"AssumeRolePolicyDocument\":{\"Statement\":[{\"Action\":[\"sts:AssumeRole\"],\"Effect\":\"Allow\",\"Principal\":{\"AWS\":{\"Fn::Join\":[\"\",[\"arn:aws:sts::\",{\"Ref\":\"AWS::AccountId\"},\":role/\",{\"Fn::Join\":[\"/\",[{\"Ref\":\"VeeamImpersonationRoleV1\"}]]}]]}}}],\"Version\":\"2012-10-17\"},\"Path\":\"/\",\"Policies\":[{\"PolicyDocument\":{\"Statement\":[{\"Action\":[\"ec2:AttachVolume\",\"ec2:CopySnapshot\",\"ec2:CreateKeyPair\",\"ec2:CreateSnapshot\",\"ec2:CreateSnapshots\",\"ec2:CreateTags\",\"ec2:CreateVolume\",\"ec2:DeleteKeyPair\",\"ec2:DeleteSnapshot\",\"ec2:DeleteTags\",\"ec2:DeleteVolume\",\"ec2:DeregisterImage\",\"ec2:DescribeAccountAttributes\",\"ec2:DescribeAvailabilityZones\",\"ec2:DescribeImages\",\"ec2:DescribeInstanceAttribute\",\"ec2:DescribeInstances\",\"ec2:DescribeInstanceStatus\",\"ec2:DescribeKeyPairs\",\"ec2:DescribeRegions\",\"ec2:DescribeSecurityGroups\",\"ec2:DescribeSnapshots\",\"ec2:DescribeSubnets\",\"ec2:DescribeRouteTables\",\"ec2:DescribeVolumes\",\"ec2:DescribeVpcEndpoints\",\"ec2:DescribeVpcs\",\"ec2:DescribeTags\",\"ec2:DetachVolume\",\"ec2:ImportImage\",\"ec2:ModifyInstanceAttribute\",\"ec2:ModifySnapshotAttribute\",\"ec2:RunInstances\",\"ec2:StartInstances\",\"ec2:StopInstances\",\"ec2:TerminateInstances\",\"events:DeleteRule\",\"events:DescribeRule\",\"events:ListTargetsByRule\",\"events:PutRule\",\"events:PutTargets\",\"events:RemoveTargets\",\"iam:AddRoleToInstanceProfile\",\"iam:AttachRolePolicy\",\"iam:CreateInstanceProfile\",\"iam:CreateRole\",\"iam:DeleteInstanceProfile\",\"iam:DeleteRole\",\"iam:DeleteRolePolicy\",\"iam:DetachRolePolicy\",\"iam:GetInstanceProfile\",\"iam:GetRole\",\"iam:ListAttachedRolePolicies\",\"iam:ListInstanceProfilesForRole\",\"iam:ListRolePolicies\",\"iam:PassRole\",\"iam:PutRolePolicy\",\"iam:RemoveRoleFromInstanceProfile\",\"kms:DescribeKey\",\"kms:ListAliases\",\"kms:ListKeys\",\"s3:DeleteObject\",\"s3:GetBucketLocation\",\"s3:GetObject\",\"s3:ListAllMyBuckets\",\"s3:ListBucket\",\"s3:PutObject\",\"servicequotas:ListServiceQuotas\",\"sns:CreateTopic\",\"sns:DeleteTopic\",\"sns:ListSubscriptionsByTopic\",\"sns:ListTopics\",\"sns:SetTopicAttributes\",\"sns:Subscribe\",\"sns:Unsubscribe\",\"ssm:GetCommandInvocation\",\"ssm:SendCommand\",\"sts:AssumeRole\",\"sts:GetCallerIdentity\",\"sts:GetSessionToken\",\"sqs:DeleteMessage\",\"sqs:ListQueues\",\"sqs:ReceiveMessage\",\"sqs:DeleteQueue\",\"sqs:SendMessage\",\"sqs:CreateQueue\",\"sqs:SetQueueAttributes\"],\"Effect\":\"Allow\",\"Resource\":\"*\"}],\"Version\":\"2012-10-17\"},\"PolicyName\":\"vcb-policy\"}]},\"Type\":\"AWS::IAM::Role\"}},\"Rules\":{\"SubnetsInVPC\":{\"Assertions\":[{\"Assert\":{\"Fn::EachMemberIn\":[{\"Fn::ValueOfAll\":[\"AWS::EC2::Subnet::Id\",\"VpcId\"]},{\"Fn::RefAll\":\"AWS::EC2::VPC::Id\"}]},\"AssertDescription\":\"The subnet must be in the VPC\"}]}}}"
}
